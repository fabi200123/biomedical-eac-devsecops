# CARLA policy (Clinic-Aware, Risk-Weighted, Load-Aware Orchestrator)

thresholds:
  # Watermarks are fractions of allocatable cluster resources.
  cpu_watermark: 0.65        # start deferring if CPU usage > 65% of allocatable
  ram_watermark: 0.70        # start deferring if RAM usage > 70% of allocatable
  min_headroom: 0.20         # require at least 20% headroom to start a rollout

resources:
  Rmax: 6.0                  # total resource budget for concurrent picks (CPU + 0.1*GiB)

weights:
  alpha_depth: 1.0           # α · 1/(d_i+1)   (topology / sync wave)
  beta_invres: 1.0           # β · 1/r_i       (favor smaller rollouts)
  gamma_risk: 1.5            # −γ · risk_i     (penalize risky changes)
  delta_window: 1.0          # δ · window_fit  (favor clinic-approved windows)

ema:
  rollout_alpha: 0.2         # EMA smoothing for recent rollout duration

windows:
  timezone: "Europe/Bucharest"
  # Allowed windows for disruptive updates (outside clinic hours).
  # Each item is {day: MON|...|SUN|WEEKDAY|WEEKEND, start: "HH:MM", end: "HH:MM"}.
  allow:
    - { day: WEEKDAY, start: "20:00", end: "06:00" }
    - { day: WEEKEND, start: "00:00", end: "23:59" }
  # Optional explicit blocks (e.g., announced maintenance freeze).
  block: [ ]

human_in_the_loop:
  # If true, CARLA will pause automation (do not trigger sync) for high-risk apps
  # and require a manual override window to proceed.
  pause_high_risk: true
  consecutive_low_headroom_to_pause: 3   # K ticks below Δ before pausing high-risk apps
  manual_override_minutes: 45            # temporary window when an override is approved (out of scope for now)

tick:
  seconds: 30             # scheduler decision cadence (poll interval)
  max_parallel_triggers: 2  # safety cap on simultaneous Argo syncs (even if Rmax allows more)

argo:
  base_url: "https://argo-cd-argocd-server.argocd.svc.cluster.local"
  token_env: "ARGO_TOKEN"
  verify_tls: false
  app_namespace: "argocd"

telemetry:
  # If you already expose K8s metrics (metrics-server), CARLA will use them.
  # Otherwise it will fall back to node allocatable and proceed conservatively.
  prefer_k8s_metrics_api: true
  # Optional: in the future, you can query Alloy/Mimir here.

logging:
  decisions_csv: "/data/carla_runs/decisions.csv"
  rollouts_csv:  "/data/carla_runs/rollouts.csv"
  level: "INFO"
